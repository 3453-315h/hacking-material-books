### Create a Self-Signed Certificate for Code Signing

<br />

In PoweShell 3.0, the New-SelfSifgnedCertificate cmdlet was generating only SSL certificates that couldn’t be used to sign the driver and application code (unlike certificates generated by the MakeCert utility). In PowerShell 5 the new version of the New-SelfSifgnedCertificate
cmdlet can now be used to issue a Code Signing certificates.

<br />

#### Lets build our test script (my_posh_script.ps1)
```
# Malicious Code to execute
write-host "Just to test IF certificate sign was worked.." -ForeGroundColor green -BackGroundColor black
Start-Sleep -Seconds 3

```

#### Lets Run our Script (With PS ExecutionPolicy set to '[AllSigned](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7)')
Requires that all scripts and conf files are signed by a trusted publisher, including scripts written on the local computer.
![sd11](https://user-images.githubusercontent.com/23490060/72687408-6a1e7180-3af5-11ea-8d14-c0ffa221468d.png)

<br />


#### To create a self-signed certificate for signing the application code (my_posh_script.ps1), run the command:
```
$cert = New-SelfSignedCertificate -Subject "My Code Signing Certificate” -Type CodeSigningCert -CertStoreLocation cert:\LocalMachine\My
```
![sdr](https://user-images.githubusercontent.com/23490060/72689217-0dc44d80-3b07-11ea-98f6-1acadb0615b3.png)

<br />

#### Let’s try to sign our PowerShell script (my_posh_script.ps1) using this certificate:
```
Set-AuthenticodeSignature -FilePath $env:userprofile\Desktop\my_posh_script.ps1 -Certificate $cert
```
![fdr](https://user-images.githubusercontent.com/23490060/72689232-3cdabf00-3b07-11ea-9ba7-ff830fca7356.png)

**Remark:** f you are receiving an **'UnknownError'** warning when executing the command, this means that **'the certificate is not trusted'**.
Because it is located in the **'user’s personal certificates store'** -> (open certlm.msc snap-in [Windows+R -> `certlm.msc`] to see it)
![sd3](https://user-images.githubusercontent.com/23490060/72686272-bfa15100-3aea-11ea-9f1a-7ae2e2cb0cb2.png)

<br />

#### We need to move our certificate to the 'trusted root certificates' store
![sd4](https://user-images.githubusercontent.com/23490060/72686277-dba4f280-3aea-11ea-9332-9e8c274bb9fe.png)
![sd5](https://user-images.githubusercontent.com/23490060/72686281-e52e5a80-3aea-11ea-96a6-a11bf6e8e8f3.png)
![sd6](https://user-images.githubusercontent.com/23490060/72686284-ec556880-3aea-11ea-9af0-3e43c4ea8fa1.png)

<br />

#### After that, you can sign your PowerShell script with this self-signed certificate.
```
Set-AuthenticodeSignature -FilePath $env:userprofile\Desktop\my_posh_script.ps1 -Certificate $cert
```
![dsf](https://user-images.githubusercontent.com/23490060/72689414-1158d400-3b09-11ea-9d6a-449a224c1952.png)
#### After the script beeing signed, it will be append one certificate {code block} inside the PS script:
![po1](https://user-images.githubusercontent.com/23490060/72687557-d2ba1e00-3af6-11ea-840b-702ccbe4bc73.png)
#### Running the script with PS Execution-Policy set to '[AllSigned](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7)'
Requires that all scripts and conf files are signed by a trusted publisher, including scripts written on the local computer.
![sdff](https://user-images.githubusercontent.com/23490060/72687601-6a1f7100-3af7-11ea-8f95-9d611d8867b2.png)

---

<br />

**Remark:** After beeing signed, the PS script can not be changed under the risk of breaking cert code block

**Remark:** Remmenber that this certificate its only valid for the Local Machine (current PC) were it was been stored..
That meens if we port the PS script to a remote machine it will not execute, because remote machine does not contain
this certificate in there certificate store ...

<br />

#### Automation Example:
```
# Code to digitally sign one PS script
$cert = New-SelfSignedCertificate -Subject "My Code Signing Certificate” -Type CodeSigningCert -CertStoreLocation cert:\LocalMachine\My
Move-Item -Path $cert.PSPath -Destination "Cert:\CurrentUser\Root"
Set-AuthenticodeSignature -FilePath $env:tmp\my_posh_script.ps1 -Certificate $cert
```

